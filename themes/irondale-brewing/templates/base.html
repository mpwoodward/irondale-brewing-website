<!DOCTYPE html>
<html lang="{{ DEFAULT_LANG }}">
<head data-pagefind-ignore>
    {% block head %}
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}{{ SITENAME|striptags }}{% endblock title %}</title>

        {% if SITESUBTITLE %}
        <meta name="description" content="{{ SITESUBTITLE }}" />
        {% endif %}

        <link rel="stylesheet" type="text/css" href="{{ SITEURL }}/theme/css/main.css" />

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

        <!-- search -->
        <link rel="stylesheet" href="{{ SITEURL }}/pagefind/pagefind-ui.css">

        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/css/lightgallery.min.css" />        
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/css/lg-thumbnail.min.css" />
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/css/lg-zoom.min.css" />

        <link rel="icon" href="{{ SITEURL }}/theme/images/cropped-Irondale-Brewing-Logo-square-32x32.png" sizes="32x32" />
        <link rel="icon" href="{{ SITEURL }}/theme/images/cropped-Irondale-Brewing-Logo-square-192x192.png" sizes="192x192" />
        <link rel="apple-touch-icon" href="{{ SITEURL }}/theme/images/cropped-Irondale-Brewing-Logo-square-180x180.png" />
        <meta name="msapplication-TileImage" content="{{ SITEURL }}/theme/images/cropped-Irondale-Brewing-Logo-square-270x270.png" />

        <!-- google analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-BKGQBNETTH"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-BKGQBNETTH');
        </script>
    {% endblock head %}
</head>

<body class="main-wrapper">
    {% block body %}
        <div id="pagefind-search-container">
            <button class="pagefind-close-button" onclick="toggleSearchModal()" aria-label="Close search">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div> 

        <header>
            {% block header %}
                <div class="header-inner-content">
                    <div class="header-section">
                        <div class="header-row">
                            <div class="header-column">
                                <div class="header-column-image">
                                    <a href="/">
                                        <img fetchpriority="high" decoding="async" width="296" height="210" 
                                            src="{{ SITEURL }}/theme/images/Irondale-Brewing-Logo-reverse-dark-backgrounds-RGB-screen-296x210.png"
                                            alt="Irondale Brewing Logo" 
                                            title="Irondale Brewing Logo">
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endblock header %}
            {% block nav %}
                <div class="menu-section">
                    <button id="hamburger-btn" class="hamburger-button" aria-label="Toggle menu" aria-expanded="false">
                        <span class="hamburger-bar"></span>
                        <span class="hamburger-bar"></span>
                        <span class="hamburger-bar"></span>
                    </button>

                    <button id="search-mobile-btn" class="search-toggle-button" aria-label="Toggle search">
                        <span class="material-symbols-outlined">search</span>
                    </button>

                    <div class="menu-row">
                        <div class="menu-wrap">
                            <div class="primary-menu">
                                <nav id="primary-nav" class="primary-menu-nav">
                                    <ul>
                                        {% for title, link in MENUITEMS %}
                                        <li><a href="{{ link }}">{{ title }}</a></li>
                                        {% endfor %}

                                        <li class="search-desktop-item">
                                            <a href="javascript:void(0)" class="search-icon-link">
                                                <span class="material-symbols-outlined">search</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            {% endblock nav %}
        </header>
        <main class="main-content">
            {% block page_header %}
            {% endblock page_header %}

            {% block main_content_area %}
                <div id="page-container" class="main-content-container">
                    <div class="main-content-section">
                        <div class="main-content-row">
                            {% block content %}
                            {% endblock content %}
                        </div>
                    </div>
                </div>
            {% endblock main_content_area %}
        </main>
        <footer>
            {% block footer %}
            <div class="footer-section">
                <div class="footer-row clearfix">
                    <div class="footer-column footer-column-left">
                        <p>Irondale Brewing - Forging Great Beer in <a href="{{ SITEURL }}/pages/irondale-history.html">Irondale, Washington</a></p>
                        <p>
                            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank">
                                <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
                            </a>
                        </p>
                    </div>
                    <div class="footer-column footer-column-right">
                        <div class="footer-column-right-inner">
                            <p>Follow Us</p>
                            <a href="https://www.youtube.com/@irondalebrewing" target="_blank">
                                <img src="{{ SITEURL }}/theme/images/youtube-icon-32x32.png" alt="YouTube" class="social-icon">
                            </a>
                            <a href="https://www.facebook.com/IrondaleBrewing" target="_blank">
                                <img src="{{ SITEURL }}/theme/images/fb-icon-32x32.png" alt="Facebook" class="social-icon">
                            </a>
                            <a href="https://www.instagram.com/irondalebrewing/" target="_blank">
                                <img src="{{ SITEURL }}/theme/images/ig-icon-32x32.png" alt="Instagram" class="social-icon">
                            </a>
                        </div>
                    </div>
                </div>
                <div class="footer-row-bottom">
                    <p>Powered by <a href="https://getpelican.com/" target="_blank">Pelican</a>.</p>
                </div>
            </div>
            {% endblock footer %}
        </footer>
    {% endblock body %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/lightgallery.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/thumbnail/lg-thumbnail.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/zoom/lg-zoom.min.js"></script>
    
    <script>
        // Initialize LightGallery
        const galleries = document.querySelectorAll('.photo-gallery'); 
        
        for (let i = 0; i < galleries.length; i++) {
            lightGallery(galleries[i], { 
                selector: '.gallery-images a', // Target <a> tags inside the inner container
                plugins: [lgZoom, lgThumbnail] // Initialize the plugins
            });
        }

        // hamburger menu
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const nav = document.getElementById('primary-nav');

        hamburgerBtn.addEventListener('click', () => {
            nav.classList.toggle('is-active');
            const isExpanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
            hamburgerBtn.setAttribute('aria-expanded', !isExpanded);
        });
    </script>

    <!-- search -->
    <script src="{{ SITEURL }}/pagefind/pagefind-ui.js" type="text/javascript"></script>
    <script>
        // 1. Initialize Pagefind UI (Runs immediately after script loads)
        new PagefindUI({
            element: "#pagefind-search-container",
            showImages: false,
            autofocus: false,
            styles: {
                // Minimal, targeted styles injected into Pagefind's shadow DOM.
                // Keep only what is necessary to ensure internal scrolling works.
                "bundle": `
                    display: flex;
                    flex-direction: column;
                    height: 100%;

                    /* Ensure the inner results-area has breathing room at the bottom
                       so buttons rendered there (like "Load more results") are not
                       flush with the viewport. This targets the component's
                       internal class from the shadow DOM. */
                          /* Target the drawer and results-area to ensure space at the
                              bottom of the scrollable area. Use !important to override
                              any internal rules that might otherwise cancel the spacing. */
                          .pagefind-ui__drawer { padding-bottom: 48px !important; }
                          .pagefind-ui__results-area { padding-bottom: 48px !important; }

                          /* Add a small margin to Pagefind buttons as well */
                          .pagefind-ui__button { margin-bottom: 12px !important; }
                `,
                "form": `flex-shrink: 0;`,
                "results": `flex-grow: 1; overflow-y: auto; min-height: 0; padding-bottom: 40px;`
            }
            // baseUrl is omitted as per your working configuration
        });

        // Ensure there's always a small spacer at the end of the results area
        // inside Pagefind's shadow DOM. Some Pagefind builds re-render the
        // results and may replace nodes, so we both try immediately and set
        // up a MutationObserver to re-apply the spacer when results change.
        const ensurePagefindSpacer = () => {
            const container = document.getElementById('pagefind-search-container');
            const host = container && container.querySelector('pagefind-ui');
            if (!host) return false;
            const sr = host.shadowRoot;
            if (!sr) return false;
            const drawer = sr.querySelector('.pagefind-ui__drawer') || sr.querySelector('.pagefind-ui__results-area');
            if (!drawer) return false;
            if (!sr.querySelector('.copilot-spacer')) {
                const spacer = document.createElement('div');
                spacer.className = 'copilot-spacer';
                spacer.style.height = '48px';
                spacer.style.display = 'block';
                spacer.style.pointerEvents = 'none';
                drawer.appendChild(spacer);
            }
            return true;
        };

        const startPagefindSpacerWatcher = () => {
            const container = document.getElementById('pagefind-search-container');
            const host = container && container.querySelector('pagefind-ui');
            if (!host || !host.shadowRoot) return;
            const sr = host.shadowRoot;
            const drawer = sr.querySelector('.pagefind-ui__drawer') || sr.querySelector('.pagefind-ui__results-area');
            if (!drawer) return;
            if (window.__pagefindSpacerObserver) return;
            const obs = new MutationObserver(() => {
                ensurePagefindSpacer();
            });
            obs.observe(drawer, { childList: true, subtree: true });
            window.__pagefindSpacerObserver = obs;
        };

        // Try immediately and again shortly after (to catch late renders)
        ensurePagefindSpacer();
        setTimeout(() => { ensurePagefindSpacer(); startPagefindSpacerWatcher(); }, 300);

        // Robustly inject a style into Pagefind's open shadowRoot. Some builds
        // render asynchronously; retry a few times until the target element
        // exists. This ensures `.pagefind-ui__results-area` receives padding.
        const injectShadowStyles = (opts = {}) => {
            const maxAttempts = opts.maxAttempts || 30;
            const interval = opts.interval || 200;
            let attempts = 0;

            const tryInject = () => {
                attempts += 1;
                const container = document.getElementById('pagefind-search-container');
                const host = container && container.querySelector('pagefind-ui');
                if (!host) {
                    if (attempts < maxAttempts) return setTimeout(tryInject, interval);
                    return false;
                }
                const sr = host.shadowRoot;
                if (!sr) {
                    if (attempts < maxAttempts) return setTimeout(tryInject, interval);
                    return false;
                }

                // If style already injected, nothing to do
                if (sr.getElementById('copilot-pagefind-style')) return true;

                // Wait until the results-area exists inside the shadowRoot
                const resultsArea = sr.querySelector('.pagefind-ui__results-area');
                if (!resultsArea && attempts < maxAttempts) return setTimeout(tryInject, interval);

                try {
                    const s = document.createElement('style');
                    s.id = 'copilot-pagefind-style';
                    s.textContent = `
                        .pagefind-ui__results-area { padding-bottom: 48px !important; }
                        .pagefind-ui__drawer { padding-bottom: 48px !important; }
                        .pagefind-ui__button { margin-bottom: 12px !important; }
                    `;
                    sr.appendChild(s);
                    return true;
                } catch (err) {
                    if (attempts < maxAttempts) return setTimeout(tryInject, interval);
                    return false;
                }
            };

            tryInject();
        };

        // Kick off injection attempts now and when the overlay opens
        injectShadowStyles();

        // Fallback: Pagefind may render its DOM directly inside
        // #pagefind-search-container (no custom element). Watch that
        // container and apply padding/margins to the results-area/button
        // once they're created. This mirrors the DevTools edit you found
        // effective.
        const applyResultsAreaPadding = (root = document) => {
            try {
                const container = document.getElementById('pagefind-search-container');
                if (!container) return false;

                // look for results-area(s) inside the container (light DOM)
                const resultsAreas = container.querySelectorAll('.pagefind-ui__results-area');
                resultsAreas.forEach(el => {
                    el.style.paddingBottom = '48px';
                    el.style.boxSizing = 'border-box';
                });

                const drawers = container.querySelectorAll('.pagefind-ui__drawer');
                drawers.forEach(el => el.style.paddingBottom = '24px');

                const buttons = container.querySelectorAll('.pagefind-ui__button');
                buttons.forEach(el => el.style.marginBottom = '12px');

                return resultsAreas.length > 0 || drawers.length > 0 || buttons.length > 0;
            } catch (err) {
                return false;
            }
        };

        // Observe the container for added nodes and apply styles when the
        // Pagefind structure appears in the light DOM.
        (function watchContainerForPagefind() {
            const container = document.getElementById('pagefind-search-container');
            if (!container) return;
            // Apply immediately in case elements are already present
            applyResultsAreaPadding();

            const obs = new MutationObserver((mutations) => {
                // Try to apply whenever children change
                if (applyResultsAreaPadding()) {
                    // once applied, keep applying on future mutations (Pagefind
                    // may re-render), so we don't disconnect the observer
                }
            });

            obs.observe(container, { childList: true, subtree: true });
            // store so other code can disconnect later if needed
            window.__pagefindContainerObserver = obs;
        })();

        // If the user clicks the internal "Load more results" button, nudge
        // the overlay scroll so the button isn't flush with the viewport bottom.
        // We listen on the document so this works even if the button is rendered
        // inside Pagefind's shadow DOM (the click will bubble as a composed event).
        document.addEventListener('click', (ev) => {
            const btn = ev.target.closest && ev.target.closest('.pagefind-ui__button');
            if (!btn) return;
            const container = document.getElementById('pagefind-search-container');
            if (!container) return;
            // Slight delay to allow Pagefind to append new items before nudging scroll
            setTimeout(() => {
                // Nudge overlay scroll by 48px so there's breathing room below the button
                container.scrollBy({ top: 48, left: 0, behavior: 'smooth' });
            }, 150);
        }, true);

        // 2. Define the toggle function in the global scope (Accessible by inline onclick)
        const toggleSearchModal = (e) => {
            // Check if an event object exists; if so, prevent default action for links/forms.
            // This is necessary for the opening links (<a> tags) to prevent navigation.
            e?.preventDefault();
            
            const searchContainer = document.getElementById('pagefind-search-container');
            
            if (searchContainer) {
                // CORE LOGIC: Toggle the 'is-open' class
                searchContainer.classList.toggle('is-open');

                if (searchContainer.classList.contains('is-open')) {
                    // --- Actions when OPENING ---
                    // 1. Prevent body from scrolling
                    document.body.classList.add('no-scroll');
                    // 2. Focus input and close mobile menu
                    searchContainer.querySelector('.pagefind-ui__search-input')?.focus();
                    document.getElementById('primary-nav')?.classList.remove('is-active');
                    document.getElementById('hamburger-btn')?.setAttribute('aria-expanded', 'false');
                    // 3. Ensure the Pagefind shadow-root has our spacer/style
                    try {
                        ensurePagefindSpacer();
                        startPagefindSpacerWatcher();
                        const host = searchContainer.querySelector('pagefind-ui');
                        if (host && host.shadowRoot && !host.shadowRoot.getElementById('copilot-pagefind-style')) {
                            const s = document.createElement('style');
                            s.id = 'copilot-pagefind-style';
                            s.textContent = `
                                .pagefind-ui__drawer { padding-bottom: 48px !important; }
                                .pagefind-ui__results-area { padding-bottom: 48px !important; }
                                .pagefind-ui__button { margin-bottom: 12px !important; }
                            `;
                            host.shadowRoot.appendChild(s);
                        }
                    } catch (err) {
                        // ignore - best-effort only
                    }
                } else {
                    // --- Actions when CLOSING ---
                    // 1. Re-enable body scrolling
                    document.body.classList.remove('no-scroll');
                }
            }
        };
        
        // 3. Attach listeners when DOM is ready (Only for opening buttons/links and ESC key)
        window.addEventListener('DOMContentLoaded', () => {
            // Select all elements that should OPEN the modal and attach the handler
            const openSelectors = [
                '.search-icon-link',          // Desktop magnifying glass link
                '#search-mobile-btn',         // Mobile magnifying glass button
            ];

            openSelectors.forEach(selector => {
                document.querySelector(selector)?.addEventListener('click', toggleSearchModal);
            });

            // ESC Key Listener (Already verified and works correctly)
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape" && document.getElementById('pagefind-search-container')?.classList.contains('is-open')) {
                    e.preventDefault(); 
                    toggleSearchModal(e);
                }
            });
        });
    </script>
</body>
</html>